# MarkItDown Website - Nginx 設定範本
#
# 使用方式：
#   1. 將此檔案複製至 /etc/nginx/sites-available/markitdown
#   2. 修改 server_name 和 root 路徑
#   3. 建立符號連結：ln -s /etc/nginx/sites-available/markitdown /etc/nginx/sites-enabled/
#   4. 測試設定：nginx -t
#   5. 重新載入：nginx -s reload

server {
    listen 80;
    listen [::]:80;

    # 修改為你的網域或 IP
    server_name your-domain.com;

    # 修改為實際部署路徑
    root /var/www/markitdown-website;
    index index.html;

    # ── 必要：SharedArrayBuffer 安全標頭 ──────────────────────────────────
    # Pyodide 需要這兩個標頭才能使用 SharedArrayBuffer
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    add_header Cross-Origin-Embedder-Policy "require-corp" always;

    # ── MIME Types ─────────────────────────────────────────────────────────
    types {
        text/html                             html htm;
        text/css                              css;
        application/javascript                js;
        application/json                      json;
        application/wasm                      wasm;      # WebAssembly
        application/octet-stream              whl;       # Python wheels
    }

    # ── 快取策略 ───────────────────────────────────────────────────────────
    # pyodide/ 和 wheels/ 內容不會變動，可以積極快取
    location ~* ^/(pyodide|wheels)/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        # 重要：子目錄也需要 COOP/COEP 標頭
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Resource-Policy "same-origin" always;
    }

    # sw.js：Service Worker 腳本絕不可快取（含 4xx）
    location = /sw.js {
        expires -1;
        add_header Cache-Control "no-store, no-cache, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Cross-Origin-Opener-Policy  "same-origin"  always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
    }

    # HTML、JS、CSS 不快取（方便更新）
    location ~* \.(html|js|css)$ {
        expires -1;
        add_header Cache-Control "no-cache";
    }

    # 所有路由回到 index.html
    location / {
        try_files $uri $uri/ /index.html;
    }

    # ── 安全性 ─────────────────────────────────────────────────────────────
    # 隱藏 Nginx 版本號
    server_tokens off;
}
