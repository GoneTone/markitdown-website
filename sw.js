/**
 * sw.js ??Service Worker
 *
 * 快�?策略�? *   UI 資�?（HTML/CSS/JS/?��?）�? stale-while-revalidate
 *   /pyodide/**                 ??cache-first（�??�固定�?
 *   /wheels/**                  ??cache-first（�??�固定�?
 *
 * ?�新?��?：修??CACHE_VERSION ?�可強制?�?�客?�端清除?�快?��? */

const CACHE_VERSION = 'v2';

const CACHE_NAMES = {
  ui:      `ui-${CACHE_VERSION}`,
  pyodide: `pyodide-${CACHE_VERSION}`,
  wheels:  `wheels-${CACHE_VERSION}`,
};

// 安�??��?快�???UI ?��?資�?
const UI_PRECACHE = [
  '/',
  '/css/style.css',
  '/js/main.js',
  '/js/converter.worker.js',
  '/js/lib/jszip.min.js',
  '/images/favicon.svg',
  '/images/icon-192.png',
  '/images/icon-512.png',
  '/images/icon-180.png',
  '/manifest.json',
];

// ?�?� Install ?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�

self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(CACHE_NAMES.ui)
      .then((cache) => cache.addAll(UI_PRECACHE))
      .then(() => self.skipWaiting())
  );
});

// ?�?� Activate ?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�

self.addEventListener('activate', (event) => {
  event.waitUntil(
    (async () => {
      // 立即?�管?�?��??��?不�?待�??�整??      await self.clients.claim();

      // 清除不屬?�當?��??��??�快??      const currentCacheNames = Object.values(CACHE_NAMES);
      const allCacheNames = await caches.keys();
      await Promise.all(
        allCacheNames
          .filter((name) => !currentCacheNames.includes(name))
          .map((name) => caches.delete(name))
      );
    })()
  );
});

// ?�?� Fetch ?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�

self.addEventListener('fetch', (event) => {
  const { request } = event;
  const url = new URL(request.url);

  // ?��??��?源�?求�?忽略 browser-sync ??WebSocket 等�?
  if (url.origin !== self.location.origin) return;

  const path = url.pathname;

  if (path.startsWith('/pyodide/')) {
    event.respondWith(cacheFirst(request, CACHE_NAMES.pyodide));
  } else if (path.startsWith('/wheels/')) {
    event.respondWith(cacheFirst(request, CACHE_NAMES.wheels));
  } else {
    event.respondWith(staleWhileRevalidate(request, CACHE_NAMES.ui));
  }
});

// ?�?� 快�?策略?��? ?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�?�

/**
 * Cache-first：快?�命中直?��??��??�命中�?請�?網路並寫?�快?��? * ?�用?��??�固定、�??��??��?大�?資�?（pyodide?�wheels）�? */
async function cacheFirst(request, cacheName) {
  const cache = await caches.open(cacheName);
  const cached = await cache.match(request);
  if (cached) return cached;

  const response = await fetch(request);
  if (response.ok) {
    cache.put(request, response.clone()).catch(() => {});
  }
  return response;
}

/**
 * Stale-while-revalidate：�??��??�快?��??��?）�??��??�景?�新快�??? * ?�用??UI 資�?（�?要即?�可?��?但�?要接?�更?��??? */
async function staleWhileRevalidate(request, cacheName) {
  const cache = await caches.open(cacheName);
  const cached = await cache.match(request);

  // ?�景?�新（�? await，�??��??�傳�?  const networkFetch = fetch(request).then((response) => {
    if (response.ok) {
      cache.put(request, response.clone()).catch(() => {});
    }
    return response;
  }).catch(() => null);

  // ?�快?�就立即?�傳，否?��?網路；兩?��??��??�傳 503
  return cached ?? await networkFetch ?? new Response('Offline', { status: 503 });
}
